<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>ArcGIS Maps SDK for JavaScript Tutorials: Display a map</title>

    <style>
      html,
      body,
      #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }
    </style>

    <link rel="stylesheet" href="https://js.arcgis.com/4.26/esri/themes/dark/main.css">
    <script src="https://js.arcgis.com/4.26/"></script>
    <script src="config.js"></script>

    <script>
      require([
        "esri/config",
        "esri/Map",
        "esri/views/MapView",
        "esri/layers/FeatureLayer",
      ], function (esriConfig, Map, MapView, FeatureLayer) {
        esriConfig.apiKey = apiKey;

        const map = new Map({
          basemap: "arcgis-dark-gray", // Basemap layer service
        });

        const view = new MapView({
          container: "viewDiv",
          map: map,
          center: [8.5417, 47.3769], // Zurich coordinates
          zoom: 13,
        });



const boundryLayer = new FeatureLayer({
  url: "https://services1.arcgis.com/aj3aipVBpIl0LroJ/arcgis/rest/services/zurichboundries/FeatureServer/0",
});

map.add(boundryLayer);


const dataLayer = new FeatureLayer({
  url: "https://services1.arcgis.com/aj3aipVBpIl0LroJ/arcgis/rest/services/testdata/FeatureServer"
});



const query = dataLayer.createQuery();
query.where = "StichtagDatJahr = 2020 AND SteuerTarifLang = 'Grundtarif'";
query.outFields = ["SteuerEinkommen_p50", "KreisLang"];

dataLayer.queryFeatures(query).then(function(response){
  // Create a dictionary to hold the SteuerEinkommen_p50 values for each district
  const districtData = {};
  response.features.forEach(function(feature){
    districtData[feature.attributes.KreisLang] = (Math.round(feature.attributes.SteuerEinkommen_p50)*1000);
  });


  // Set up a listener for the click event on the boundary layer
  view.on("click", function(event) {
  view.hitTest(event).then(function(response) {
    const feature = response.results[0].graphic;
    if (feature) {
      const query = boundryLayer.createQuery();
      query.geometry = event.mapPoint;
      boundryLayer.queryFeatures(query).then(function(response) {
        const attributes = response.features[0].attributes;

          // Set up the popup for the boundary layer
    const popupTemplate = {
    title: "{bezeichnun}",
    content: "Median Income: " + districtData[attributes.bezeichnun].toLocaleString('en', {maximumFractionDigits: 0}) + " CHF",
  };
  boundryLayer.popupTemplate = popupTemplate;

      });
    }
  });
});





// Create a new field in the boundary layer's attribute table to hold the income values
// const incomeField = {
//   name: "Median_Income",
//   alias: "Median Income",
//   type: "integer"
// };
// boundryLayer.fields.push(incomeField);

// const query = boundryLayer.createQuery();

boundryLayer.queryFeatures(query).then(function(response) {
        const attributes = response.features[0].attributes;
        // Loop through each feature in the boundary layer and assign the income value from the dictionary to the new field
        response.features.forEach(function(feature) {
          const kreis = attributes.bezeichnun;
          if (kreis in districtData) {
            attributes.Median_Income = districtData[kreis];
  }
});







});
});
});











</script>
</head>
<body>
  <div id="viewDiv">

  </div>
</body>
</html>